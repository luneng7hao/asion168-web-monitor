(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function I(){return!!(typeof wx<"u"&&wx.getSystemInfo)}class w{constructor(e){if(this.queue=[],this.isSending=!1,this.initialized=!1,!e.projectId||!e.projectId.trim()){console.error("Monitor SDK: projectId 是必需的，请在管理端创建项目后获取项目ID"),this.initialized=!1,this.config=e,this.sessionId="";return}if(!e.apiUrl||!e.apiUrl.trim()){console.error("Monitor SDK: apiUrl 是必需的"),this.initialized=!1,this.config=e,this.sessionId="";return}if(this.config={enableError:!0,enablePerformance:!0,enableBehavior:!0,enableApi:!0,sampleRate:1,...e},this.sessionId=this.generateSessionId(),this.initialized=!0,I()){console.warn("检测到微信小程序环境，请使用 miniprogram.ts 版本");return}this.init()}generateSessionId(){const e="monitor_session_id";if(typeof window<"u"&&window.localStorage){const i=localStorage.getItem(e);if(i)return i}const t=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return typeof window<"u"&&window.localStorage&&localStorage.setItem(e,t),t}decodeUrl(e){try{return decodeURIComponent(e)}catch{return e}}init(){this.initialized&&(this.config.enableError&&this.initErrorMonitor(),this.config.enablePerformance&&this.initPerformanceMonitor(),this.config.enableBehavior&&this.initBehaviorMonitor(),this.config.enableApi&&this.initApiMonitor())}initErrorMonitor(){this.initialized&&(window.addEventListener("error",e=>{var t;if(!(!this.initialized||Math.random()>(this.config.sampleRate||1))){if(e.target&&e.target.tagName){const i=e.target;if(["IMG","SCRIPT","LINK","VIDEO","AUDIO"].includes(i.tagName)){const n=i.src||i.href||i.src||i.src||i.src||"";if(this.isMonitorRequest(n))return;const r={type:"resource",message:`资源加载失败: ${n}`,url:this.decodeUrl(window.location.href),timestamp:new Date().toISOString(),userAgent:navigator.userAgent,userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId};this.reportError(r);return}}if(e.error){const i={type:"js",message:e.message,stack:(t=e.error)==null?void 0:t.stack,url:this.decodeUrl(e.filename||window.location.href),line:e.lineno,col:e.colno,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId};this.reportError(i)}}},!0),window.addEventListener("unhandledrejection",e=>{var i,n;if(Math.random()>(this.config.sampleRate||1))return;const t={type:"promise",message:((i=e.reason)==null?void 0:i.message)||String(e.reason),stack:(n=e.reason)==null?void 0:n.stack,url:this.decodeUrl(window.location.href),timestamp:new Date().toISOString(),userAgent:navigator.userAgent,userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId};this.reportError(t)}))}initPerformanceMonitor(){document.readyState==="complete"?this.collectPerformance():window.addEventListener("load",()=>{this.collectPerformance()})}collectPerformance(){if(Math.random()>(this.config.sampleRate||1))return;const e=performance.timing;if(e.loadEventEnd===0){setTimeout(()=>this.collectPerformance(),100);return}const t=e.loadEventEnd-e.navigationStart;if(t<=0||t>6e4)return;const i={loadTime:t,url:this.decodeUrl(window.location.href),timestamp:new Date().toISOString(),userAgent:navigator.userAgent,userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId};if("PerformanceObserver"in window){try{new PerformanceObserver(r=>{const s=r.getEntries().find(d=>d.name==="first-contentful-paint");s&&(i.fcp=Math.round(s.startTime))}).observe({entryTypes:["paint"]})}catch{}try{new PerformanceObserver(r=>{const a=r.getEntries(),s=a[a.length-1];s&&(i.lcp=Math.round(s.startTime))}).observe({entryTypes:["largest-contentful-paint"]})}catch{}try{new PerformanceObserver(r=>{const s=r.getEntries()[0];s&&(i.fid=Math.round(s.processingStart-s.startTime))}).observe({entryTypes:["first-input"]})}catch{}}try{let n=0;new PerformanceObserver(a=>{for(const s of a.getEntries())s.hadRecentInput||(n+=s.value);i.cls=n}).observe({entryTypes:["layout-shift"]})}catch{}setTimeout(()=>{this.reportPerformance(i)},3e3)}initBehaviorMonitor(){this.trackBehavior("pv",{url:this.decodeUrl(window.location.href),path:this.decodeUrl(window.location.pathname)}),this.trackRouteChange(),document.addEventListener("click",e=>{var n;if(Math.random()>(this.config.sampleRate||1))return;const t=e.target,i=t.getBoundingClientRect();this.trackBehavior("click",{url:this.decodeUrl(window.location.href),path:this.decodeUrl(window.location.pathname),element:t.tagName,elementId:t.id||"",className:t.className||"",text:((n=t.textContent)==null?void 0:n.substring(0,100))||"",position:{x:Math.round(i.left+i.width/2),y:Math.round(i.top+i.height/2)},timestamp:new Date().toISOString()})},!0)}trackRouteChange(){const e=history.pushState,t=history.replaceState;history.pushState=function(...i){e.apply(history,i),window.dispatchEvent(new Event("popstate"))},history.replaceState=function(...i){t.apply(history,i),window.dispatchEvent(new Event("popstate"))},window.addEventListener("popstate",()=>{this.trackBehavior("pv",{url:this.decodeUrl(window.location.href),path:this.decodeUrl(window.location.pathname)})})}isMonitorRequest(e){if(!e)return!1;const t=this.config.apiUrl,i=e.split("?")[0].split("#")[0],n=t.split("?")[0].split("#")[0];return!!(i.startsWith(n)&&(e.includes("/error/report")||e.includes("/performance/report")||e.includes("/behavior/report")||e.includes("/api/report"))||e.includes("/error/report")||e.includes("/performance/report")||e.includes("/behavior/report")||e.includes("/api/report")||e.includes(".hot-update.")||e.includes("/@vite/client")||e.includes("/@react-refresh")||e.includes("__vite_ping")||e.includes("__webpack_hmr")||e.includes("webpack-dev-server")||e.includes("sockjs-node")||e.startsWith("ws://")||e.startsWith("wss://")||e.startsWith("chrome-extension://")||e.startsWith("moz-extension://")||e.startsWith("safari-extension://")||e.startsWith("edge-extension://"))}initApiMonitor(){const e=window.fetch,t=this;window.fetch=function(...r){var l;const a=Date.now(),s=typeof r[0]=="string"?r[0]:r[0].url,d=((l=r[1])==null?void 0:l.method)||"GET";return t.isMonitorRequest(s)?e.apply(this,r):e.apply(this,r).then(u=>{const p=Date.now()-a;return Math.random()<=(t.config.sampleRate||1)&&t.reportApi({url:s,method:d,status:u.status,responseTime:p,timestamp:new Date().toISOString(),userId:t.config.userId,sessionId:t.sessionId,projectId:t.config.projectId}),u}).catch(u=>{const p=Date.now()-a;throw Math.random()<=(t.config.sampleRate||1)&&t.reportApi({url:s,method:d,status:0,responseTime:p,timestamp:new Date().toISOString(),userId:t.config.userId,sessionId:t.sessionId,projectId:t.config.projectId}),u})};const i=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(r,a,...s){return this._monitorUrl=typeof a=="string"?a:a.toString(),this._monitorMethod=r,i.apply(this,[r,a,...s])},XMLHttpRequest.prototype.send=function(...r){const a=Date.now(),s=this._monitorUrl,d=this._monitorMethod;return t.isMonitorRequest(s)?n.apply(this,r):(this.addEventListener("loadend",function(){const l=Date.now()-a;Math.random()<=(t.config.sampleRate||1)&&t.reportApi({url:s,method:d,status:this.status,responseTime:l,timestamp:new Date().toISOString(),userId:t.config.userId,sessionId:t.sessionId,projectId:t.config.projectId})}),n.apply(this,r))}}reportError(e){this.send("/error/report",e)}reportPerformance(e){this.send("/performance/report",e)}trackBehavior(e,t){const i={type:e,url:this.decodeUrl(window.location.href),path:this.decodeUrl(window.location.pathname),timestamp:new Date().toISOString(),userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId,data:{...t,userAgent:navigator.userAgent,screenSize:{width:window.screen.width,height:window.screen.height},viewportSize:{width:window.innerWidth,height:window.innerHeight},referrer:document.referrer||""}};this.send("/behavior/report",i)}reportApi(e){this.send("/api/report",e)}send(e,t){if(!this.initialized){console.warn("Monitor SDK: SDK 未正确初始化，数据无法上报");return}this.queue.push({endpoint:e,data:t}),this.flush()}sendData(e,t){const i=`${this.config.apiUrl}${e}`,n=JSON.stringify(t);if(typeof navigator<"u"&&navigator.sendBeacon&&n.length<65536)try{const r=new Blob([n],{type:"application/json"});if(navigator.sendBeacon(i,r))return!0}catch{}if(n.length<1500)try{const r=new Image,a=encodeURIComponent(n),s=`${i}?data=${a}`;return r.onerror=()=>{},r.onload=()=>{setTimeout(()=>{r.src=""},100)},r.src=s,setTimeout(()=>{r.src=""},1e3),!0}catch{}return!1}async flush(){if(!(this.isSending||this.queue.length===0)){for(this.isSending=!0;this.queue.length>0;){const e=this.queue.shift();try{this.sendData(e.endpoint,e.data)||await fetch(`${this.config.apiUrl}${e.endpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.data),keepalive:!0})}catch(t){console.error("Monitor SDK: Failed to send data",t),this.queue.unshift(e);break}}this.isSending=!1}}captureError(e,t){const i={type:"js",message:e.message,stack:e.stack,url:this.decodeUrl(window.location.href),timestamp:new Date().toISOString(),userAgent:navigator.userAgent,userId:this.config.userId,sessionId:this.sessionId,projectId:this.config.projectId,...t};this.reportError(i)}track(e,t){this.trackBehavior("custom",{eventName:e,...t})}}typeof window<"u"&&(window.Monitor=w);const h=new w({apiUrl:"http://localhost:3000/api",projectId:"001",userId:"web-user-001",enableError:!0,enablePerformance:!0,enableBehavior:!0,enableApi:!0,sampleRate:1});window.monitor=h;function c(o,e){const t=document.getElementById("logArea"),r=`<div class="log-item">
                <span class="log-time">[${new Date().toTimeString().split(" ")[0]}]</span>
                <span class="${o==="错误"?"log-error":"log-type"}">[${o}]</span>
                ${e}
            </div>`;t.innerHTML+=r,t.scrollTop=t.scrollHeight}window.triggerJsError=function(){throw c("错误","触发 JavaScript 错误..."),new Error("这是一个测试的 JavaScript 错误")};window.triggerPromiseError=function(){c("错误","触发 Promise 错误..."),Promise.reject(new Error("这是一个测试的 Promise 错误"))};window.triggerResourceError=function(){c("错误","正在触发资源加载错误...");const o=document.createElement("img");o.src="https://nonexistent-domain-12345.com/image.jpg",o.style.display="none",o.onerror=function(){c("错误","资源加载错误已触发，已上报到监控系统"),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},1e3)},document.body.appendChild(o)};window.captureManualError=function(){try{null.doSomething()}catch(o){h.captureError(o,{action:"手动捕获",page:"index.html"}),c("错误","错误已手动捕获并上报"),alert("错误已捕获并上报到监控系统")}};window.trackCustomEvent=function(){h.track("custom_event",{action:"click",button:"trackCustomEvent",page:"index.html"}),c("行为","自定义事件已追踪"),alert("自定义事件已追踪")};window.trackButtonClick=function(){h.track("button_click",{buttonId:"trackButtonClick",buttonText:"追踪按钮点击",timestamp:new Date().toISOString()}),c("行为","按钮点击事件已追踪"),alert("按钮点击事件已追踪")};window.testSuccessApi=function(){c("接口","发起成功 API 请求..."),fetch("http://localhost:3000/api/dashboard/overview").then(o=>{if(o.ok)return o.json();throw new Error("请求失败")}).then(o=>{c("接口","API 请求成功，状态码：200，已监控"),alert("成功 API 请求已完成，已监控！")}).catch(o=>{c("错误","API 请求失败："+o.message),alert("请求失败，请确保后端服务正在运行")})};window.testXHR=function(){c("接口","发起 XHR 请求...");const o=new XMLHttpRequest;o.open("GET","https://api.github.com/users/octocat"),o.onload=function(){c("接口","XHR 请求成功，状态码："+o.status),alert("XHR 请求成功，已监控")},o.onerror=function(){c("错误","XHR 请求失败")},o.send()};window.testFetch=function(){c("接口","发起 Fetch 请求..."),fetch("https://api.github.com/users/octocat").then(o=>{c("接口","Fetch 请求成功，状态码："+o.status),alert("Fetch 请求成功，已监控")}).catch(o=>{c("错误","Fetch 请求失败")})};window.testErrorRequest=function(){c("接口","发起错误请求..."),fetch("https://nonexistent-domain-12345.com/api").then(o=>{c("接口","请求完成")}).catch(o=>{c("错误","请求失败（已监控）"),alert("错误请求已监控")})};window.reloadPage=function(){c("性能","重新加载页面以测试性能数据采集..."),window.location.reload()};window.simulateHeavyTask=function(){c("性能","开始模拟重任务...");const o=Date.now(),t=Date.now()-o;c("性能",`重任务完成，耗时：${t}ms`),alert(`重任务完成，耗时：${t}ms`)};window.testFID=function(){c("性能","测试 FID（首次输入延迟）- 点击此按钮即可触发"),alert("FID 测试：点击此按钮时，SDK 会自动测量首次输入延迟。请查看性能监控页面查看结果。")};window.testCLS=function(){c("性能","测试 CLS（累积布局偏移）...");const o=document.createElement("img");o.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Q0xTIFRlc3Q8L3RleHQ+PC9zdmc+",o.style.width="400px",o.style.height="300px",o.style.margin="20px",o.style.border="2px solid #667eea",o.style.borderRadius="8px";const e=document.querySelector(".container");e&&(e.appendChild(o),c("性能","已插入图片，模拟布局偏移"),alert("已插入图片模拟布局偏移。CLS 值会由 SDK 自动测量。"))};function y(){if(typeof PerformanceObserver>"u")return;const o=document.getElementById("performance-metrics");if(o){if(o.style.display="block",performance.timing&&performance.timing.loadEventEnd){const e=performance.timing.loadEventEnd-performance.timing.navigationStart,t=document.getElementById("metric-loadTime");t&&(t.textContent=e)}try{new PerformanceObserver(t=>{const n=t.getEntries().find(r=>r.name==="first-contentful-paint");if(n){const r=document.getElementById("metric-fcp");r&&(r.textContent=Math.round(n.startTime))}}).observe({entryTypes:["paint"]})}catch{}try{new PerformanceObserver(t=>{const i=t.getEntries(),n=i[i.length-1];if(n){const r=document.getElementById("metric-lcp");r&&(r.textContent=Math.round(n.startTime))}}).observe({entryTypes:["largest-contentful-paint"]})}catch{}try{new PerformanceObserver(t=>{const n=t.getEntries()[0];if(n&&n.processingStart&&n.startTime){const r=document.getElementById("metric-fid");r&&(r.textContent=Math.round(n.processingStart-n.startTime))}}).observe({entryTypes:["first-input"]})}catch{}try{let e=0;new PerformanceObserver(i=>{for(const r of i.getEntries())!r.hadRecentInput&&r.value&&(e+=r.value);const n=document.getElementById("metric-cls");n&&(n.textContent=e.toFixed(2))}).observe({entryTypes:["layout-shift"]})}catch{}}}window.addEventListener("load",function(){c("性能","页面加载完成，性能数据已采集"),setTimeout(y,500)});function g(){const o=document.getElementById("btn-trigger-js-error"),e=document.getElementById("btn-trigger-promise-error"),t=document.getElementById("btn-trigger-resource-error"),i=document.getElementById("btn-capture-manual-error"),n=document.getElementById("btn-track-custom-event"),r=document.getElementById("btn-track-button-click"),a=document.getElementById("btn-test-success-api"),s=document.getElementById("btn-test-xhr"),d=document.getElementById("btn-test-fetch"),l=document.getElementById("btn-test-error-request"),u=document.getElementById("btn-reload-page"),p=document.getElementById("btn-simulate-heavy-task"),f=document.getElementById("btn-test-fid"),m=document.getElementById("btn-test-cls");o&&o.addEventListener("click",window.triggerJsError),e&&e.addEventListener("click",window.triggerPromiseError),t&&t.addEventListener("click",window.triggerResourceError),i&&i.addEventListener("click",window.captureManualError),n&&n.addEventListener("click",window.trackCustomEvent),r&&r.addEventListener("click",window.trackButtonClick),a&&a.addEventListener("click",window.testSuccessApi),s&&s.addEventListener("click",window.testXHR),d&&d.addEventListener("click",window.testFetch),l&&l.addEventListener("click",window.testErrorRequest),u&&u.addEventListener("click",window.reloadPage),p&&p.addEventListener("click",window.simulateHeavyTask),f&&f.addEventListener("click",window.testFID),m&&m.addEventListener("click",window.testCLS)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();
